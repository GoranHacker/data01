---
title: "Test de Precios"
author: "YGS UI SNP"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: true
    output_file: index.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(httr)
library(readxl)
library(dplyr)
library(knitr)
library(kableExtra)
library(tidyr)
library(ggplot2)


# URL del archivo Excel publicado
excel_url <- "https://docs.google.com/spreadsheets/d/e/2PACX-1vSNvzxvxCHOZNa1FlmSHuhm5sqrNz5wOGCMtXYUqRGQ8uBJfaRSvyGFqm4bcihb8myUV7mOXlTtI7wh/pub?output=xlsx"

# Descargar el archivo Excel a un archivo temporal
temp_file <- tempfile(fileext = ".xlsx")
download.file(excel_url, temp_file, mode = "wb")

# Leer el archivo Excel desde el archivo temporal
datos <- read_excel(temp_file)

# Opcionalmente, eliminar el archivo temporal si ya no se necesita
unlink(temp_file)

## Filtrar los datos por la última fecha ##
# Identificar la última fecha
ultima_fecha <- max(datos$FECHA)

# Filtrar los datos para incluir solo la última fecha
datos_ultima_fecha <- datos[datos$FECHA == ultima_fecha, ]





```{r results-table, results='asis', echo=FALSE}
if(nrow(datos_ultima_fecha) > 0) {
  ## Calcular los precios por especie para la última fecha ##
  precios_por_especie <- datos_ultima_fecha %>%
    group_by(ESPECIE) %>%
    summarize(
      PRECIO_KG = mean(PRECIO_KG, na.rm = TRUE),
      PRECIO_CAJA = mean(PRECIO_CAJA, na.rm = TRUE),
      PRECIO_MALLA = mean(PRECIO_MALLA, na.rm = TRUE)
    )
  
  # Formatear la última fecha para incluirla en el título de la tabla
  fecha_formateada <- format(as.Date(ultima_fecha), "%d de %B de %Y")
  
  # Presentar los resultados en forma de tabla
  precios_por_especie %>%
    kable("html", caption = paste("Precios por especie para el", fecha_formateada)) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "bordered"))
} else {
  print("No hay datos disponibles para la última fecha.")
}





```{r alertas-multiples, echo=FALSE}

# Definir una lista de especies y condiciones de alerta con estructura adecuada
especies_alertas <- list(
  "MERLUZA COMUN" = list(PRECIO_CAJA = 15000, PRECIO_KG = 2000),
  "MERLUZA AUSTRAL" = list(PRECIO_CAJA = 25000, PRECIO_KG = 4000),
  "CONGRIO DORADO" = list(PRECIO_KG = 4000),
  "JUREL" = list(PRECIO_CAJA = 15000, PRECIO_KG = 2000),
  "REINETA" = list(PRECIO_KG = 2500),
  "ALMEJA" = list(PRECIO_MALLA = 30000),
  "CHORITO" = list(PRECIO_MALLA = 10000),
  "LOCOS" = list(PRECIO_KG = 10000)
)

# Procesar alertas para cada especie
for (especie in names(especies_alertas)) {
  condiciones <- especies_alertas[[especie]]
  datos_especie <- precios_por_especie %>%
    filter(ESPECIE == especie) %>%
    summarize(
      PRECIO_CAJA_MIN = if ("PRECIO_CAJA" %in% names(condiciones)) min(PRECIO_CAJA, na.rm = TRUE) else NA,
      PRECIO_KG_MIN = if ("PRECIO_KG" %in% names(condiciones)) min(PRECIO_KG, na.rm = TRUE) else NA,
      PRECIO_MALLA_MIN = if ("PRECIO_MALLA" %in% names(condiciones)) min(PRECIO_MALLA, na.rm = TRUE) else NA
    )

  # Verificar condiciones para cada especie
  alerta_activada <- FALSE
  if (nrow(datos_especie) > 0) {
    if (!is.na(datos_especie$PRECIO_CAJA_MIN) && datos_especie$PRECIO_CAJA_MIN <= condiciones$PRECIO_CAJA) {
      alerta_activada <- TRUE
    }
    if (!is.na(datos_especie$PRECIO_KG_MIN) && datos_especie$PRECIO_KG_MIN <= condiciones$PRECIO_KG) {
      alerta_activada <- TRUE
    }
    if (!is.na(datos_especie$PRECIO_MALLA_MIN) && datos_especie$PRECIO_MALLA_MIN <= condiciones$PRECIO_MALLA) {
      alerta_activada <- TRUE
    }

    if (alerta_activada) {
      print(paste("Precio", especie, "Riesgoso"))
    }
  }
}



## Tercer Producto Analisis del ultimo mes ####
### Definir base de datos del ultimo mes ####
# Asegurarse de que ultima_fecha es un objeto Date
ultima_fecha <- as.Date(ultima_fecha)

# Calcular la fecha de inicio para los últimos 30 días
fecha_inicio <- as.Date(ultima_fecha - 30)

# Asegurando que la columna FECHA es de tipo Date
datos$FECHA <- as.Date(datos$FECHA)

# Filtrar los datos para incluir solo las entradas de los últimos 30 días
### Base de datos 30 dias
datos_30_dias <- datos %>%
  filter(FECHA >= fecha_inicio & FECHA <= ultima_fecha)

# Orden especificado para las especies
orden_especies <- c("MERLUZA COMUN", "MERLUZA AUSTRAL", "REINETA", "CONGRIO DORADO", "JUREL", "LOCOS", "CHORITO", "ALMEJA")



```{r estadisticos-ordenadosx, echo=FALSE, results='asis'}
library(dplyr)
library(knitr)
library(kableExtra)

cat("## Precios Durante los Últimos 30 Días\n")

# Procesar y mostrar los datos para cada especie
for (especie in orden_especies) {
  datos_especie <- datos_30_dias %>%
    filter(ESPECIE == especie) %>%
    summarise(
      Media_KG = round(mean(PRECIO_KG, na.rm = TRUE), 0),
      Minimo_KG = round(min(PRECIO_KG, na.rm = TRUE), 0),
      Maximo_KG = round(max(PRECIO_KG, na.rm = TRUE), 0),
      Media_CAJA = round(mean(PRECIO_CAJA, na.rm = TRUE), 0),
      Minimo_CAJA = round(min(PRECIO_CAJA, na.rm = TRUE), 0),
      Maximo_CAJA = round(max(PRECIO_CAJA, na.rm = TRUE), 0),
      Media_MALLA = round(mean(PRECIO_MALLA, na.rm = TRUE), 0),
      Minimo_MALLA = round(min(PRECIO_MALLA, na.rm = TRUE), 0),
      Maximo_MALLA = round(max(PRECIO_MALLA, na.rm = TRUE), 0)
    )

  # Crear una tabla clara y legible
  if(nrow(datos_especie) > 0) {
    cat(paste("\n\n###", especie, "\n"))
    datos_tabla <- rbind(
      c("KG", datos_especie$Media_KG, datos_especie$Minimo_KG, datos_especie$Maximo_KG),
      c("CAJA", datos_especie$Media_CAJA, datos_especie$Minimo_CAJA, datos_especie$Maximo_CAJA),
      c("MALLA", datos_especie$Media_MALLA, datos_especie$Minimo_MALLA, datos_especie$Maximo_MALLA)
    )
    colnames(datos_tabla) <- c("Tipo", "Media", "Mínimo", "Máximo")
    print(
      knitr::kable(datos_tabla, "html") %>%
      kable_styling("striped", full_width = F) %>%
      column_spec(1, bold = TRUE, border_right = TRUE)
    )
  }
}



## Cuarto Producto Grafico de Precio Promedio de Merluza en el mes
```{r precio-promedio-merluza, echo=FALSE, results='asis'}
library(dplyr)
library(knitr)
library(kableExtra)

cat("## Precio Promedio de Merluza Común\n")

# Filtrar y agrupar los datos para Merluza Común
merluza_comun_datos <- datos_30_dias %>%
  filter(ESPECIE == "MERLUZA COMUN") %>%
  group_by(FECHA) %>%
  summarise(
    PRECIO_KG = max(PRECIO_KG, na.rm = TRUE),  # Usar max para obtener un valor no-NA si está disponible
    PRECIO_CAJA = max(PRECIO_CAJA, na.rm = TRUE),
    Precio_Kilo_De_Caja = ifelse(!is.na(PRECIO_CAJA) && PRECIO_CAJA != 0, round(PRECIO_CAJA / 27, 0), NA),
    # Asegurarse de excluir Inf y -Inf en el cálculo del promedio
    Precio_Promedio = ifelse(!is.infinite(PRECIO_KG) && !is.infinite(Precio_Kilo_De_Caja),
                             round(mean(c(PRECIO_KG, ifelse(!is.na(PRECIO_CAJA), PRECIO_CAJA / 27, NA)), na.rm = TRUE), 0),
                             ifelse(!is.infinite(PRECIO_KG), PRECIO_KG,
                                    ifelse(!is.infinite(Precio_Kilo_De_Caja), Precio_Kilo_De_Caja, NA))
    )
  ) %>%
  ungroup()  # Eliminar la agrupación para operaciones futuras

# Mostrar el resultado
if(nrow(merluza_comun_datos) > 0) {
  print(
    merluza_comun_datos %>%
      select(FECHA, PRECIO_KG, PRECIO_CAJA, Precio_Kilo_De_Caja, Precio_Promedio) %>%
      kable("html", col.names = c("Fecha", "Precio por KG", "Precio por Caja", "Precio Kilo De Caja", "Precio Promedio")) %>%
      kable_styling("striped", full_width = F) %>%
      column_spec(1, bold = TRUE)
  )
} else {
  cat("No hay datos suficientes para Merluza Común.\n")
}


```{r grafico-precio-promedio-merluza-mas-fechas, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=5, results='asis'}
library(ggplot2)

# Asegurándonos de que las fechas estén en formato de fecha para que ggplot las maneje correctamente
merluza_comun_datos$FECHA <- as.Date(merluza_comun_datos$FECHA)

# Creando el gráfico para el Precio Promedio con detalles adicionales
ggplot(data = merluza_comun_datos, aes(x = FECHA, y = Precio_Promedio)) +
  geom_line(colour = "red", size = 1) +  # Línea roja
  geom_point(colour = "black", size = 3, shape = 21, fill = "pink") +  # Puntos en los datos
  geom_text(aes(label = Precio_Promedio), vjust = -0.5, colour = "black", size = 3) +  # Mostrar valores
  labs(title = "Precio Promedio de Merluza Común últimos 30 días",
       x = "Fecha",
       y = "Precio Promedio") +
  scale_x_date(date_breaks = "2 days", date_labels = "%d-%b") +  # Ajustando las etiquetas de fecha para mostrar más fechas
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotando las etiquetas de fecha para mejor visibilidad
